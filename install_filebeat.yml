---
- name: Install Filebeat
  hosts: all
  become: yes
  any_errors_fatal: true

  tasks:

    - name: Copy filebeat binary file
      copy:
        src: "{{ filebeat_rpm_path }}"
        dest: "/tmp/filebeat-8.11.1-x86_64.rpm"

    - name: Install Filebeat RPM
      shell: rpm -vi "/tmp/filebeat-8.11.1-x86_64.rpm"

    - name: Enable Kafka module for Filebeat
      command: filebeat modules enable kafka
   
    - name: Check Kafka service status
      systemd:
        name: "{{ kafka_service_name }}"
        state: started
      register: kafka_service_status

    - name: Check zookeeper service status
      systemd:
        name: "{{ zookeeper_service_name }}"
        state: started
      register: zookeeper_service_status

    - name: Check connect service status
      systemd:
        name: "{{ connect_service_name }}"
        state: started
      register: connect_service_status

    - name: Check control-center service status
      systemd:
        name: "{{ control-center_service_name }}"
        state: started
      register: control_center_service_status


    - name: Generate Filebeat configuration
      template:
        src: /ansible_playbook_filebeat/filebeat_config.j2
        dest: /etc/filebeat/filebeat.yml
        owner: root

    - name: Start Filebeat service
      command: service filebeat start
